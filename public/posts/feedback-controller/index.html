<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">
<link rel="stylesheet" href="https://www.volatileint.dev/css/custom.css">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; | Volatile Int</title>
<meta name="keywords" content="C&#43;&#43;, feedback, control, law, actuator, concept, embedded, template, lambda, logging">
<meta name="description" content="In this post, we&rsquo;re going to implement a generic interface for creating a wide variety of closed-loop control systems. We&rsquo;ll end with a flexible template library capable of implementing whatever control algorithm you&rsquo;d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C&#43;&#43; infrastructure such as template concepts,  std::expected, and lambda functions.
Before we dive in, I want to acknowledge that the final code utilizes a good number of advanced C&#43;&#43; facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.">
<meta name="author" content="">
<link rel="canonical" href="https://www.volatileint.dev/posts/feedback-controller/">
<link crossorigin="anonymous" href="https://www.volatileint.dev/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.volatileint.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.volatileint.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.volatileint.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.volatileint.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.volatileint.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://www.volatileint.dev/posts/feedback-controller/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-N81PSXWFLZ"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-N81PSXWFLZ');
        }
      </script><meta property="og:url" content="https://www.volatileint.dev/posts/feedback-controller/">
  <meta property="og:site_name" content="Volatile Int">
  <meta property="og:title" content="Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43;">
  <meta property="og:description" content="In this post, we’re going to implement a generic interface for creating a wide variety of closed-loop control systems. We’ll end with a flexible template library capable of implementing whatever control algorithm you’d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C&#43;&#43; infrastructure such as template concepts, std::expected, and lambda functions.
Before we dive in, I want to acknowledge that the final code utilizes a good number of advanced C&#43;&#43; facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-26T11:00:00-08:00">
    <meta property="article:modified_time" content="2025-11-26T11:00:00-08:00">
    <meta property="article:tag" content="C&#43;&#43;">
    <meta property="article:tag" content="Feedback">
    <meta property="article:tag" content="Control">
    <meta property="article:tag" content="Law">
    <meta property="article:tag" content="Actuator">
    <meta property="article:tag" content="Concept">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43;">
<meta name="twitter:description" content="In this post, we&rsquo;re going to implement a generic interface for creating a wide variety of closed-loop control systems. We&rsquo;ll end with a flexible template library capable of implementing whatever control algorithm you&rsquo;d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C&#43;&#43; infrastructure such as template concepts,  std::expected, and lambda functions.
Before we dive in, I want to acknowledge that the final code utilizes a good number of advanced C&#43;&#43; facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.volatileint.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Implementing a Framework For Closed-Loop Controllers in Modern C++",
      "item": "https://www.volatileint.dev/posts/feedback-controller/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Implementing a Framework For Closed-Loop Controllers in Modern C++",
  "name": "Implementing a Framework For Closed-Loop Controllers in Modern C\u002b\u002b",
  "description": "In this post, we\u0026rsquo;re going to implement a generic interface for creating a wide variety of closed-loop control systems. We\u0026rsquo;ll end with a flexible template library capable of implementing whatever control algorithm you\u0026rsquo;d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C++ infrastructure such as template concepts, std::expected, and lambda functions.\nBefore we dive in, I want to acknowledge that the final code utilizes a good number of advanced C++ facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.\n",
  "keywords": [
    "C++", "feedback", "control", "law", "actuator", "concept", "embedded", "template", "lambda", "logging"
  ],
  "articleBody": "In this post, we’re going to implement a generic interface for creating a wide variety of closed-loop control systems. We’ll end with a flexible template library capable of implementing whatever control algorithm you’d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C++ infrastructure such as template concepts, std::expected, and lambda functions.\nBefore we dive in, I want to acknowledge that the final code utilizes a good number of advanced C++ facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.\nFirst, let’s kick things off with a scenario.\nA Simple Bang-Bang Controller Picture yourself as an embedded software engineer working at a scrappy startup designing a revolutionary new technology with a healthy mix of hardware and software co-development. Your co-worker - a thermal engineer responsible for maintaining the health of a temperature-sensitive component of the system - approaches you, asking for software to regulate the temperature of their system:\nA thermoelectric cooler (henceforth referred to as a TEC) connected to the component that needs to be cooled. The engineer connected this to a simple switch which will apply either 0 or 100% power. A thermocouple connected to the device being cooled to sense the temperature. A microcontroller wired to control the TEC using the thermocouple as feedback. The system generates heat during operation, so the only active element necessary is a cooler. Analysis shows that component needs to be kept between 20 and 80 degrees Celsius. Every minute the temperature should be checked. If the reported temperature is 80 degrees of above then the TEC should be turned on until the temperature hits the lower bound of 20 degrees.\nYou write a very minimal program:\n#include #include #include \"gpio.hpp\" #include \"adc.hpp\" void control_tec() { Gpio tec{ 1 }; // TEC is on pin 1 Adc thermocouple{ 2 }; // thermocouple on pin 2 tec.Configure(Gpio::Output); thermocouple.Configure(); while (true) { const auto raw_temp_adc = thermocouple.read(); const auto temp_uc = static_cast\u003cfloat\u003e(raw) * 0.1f; if (temp_uc \u003e= 80) { tec.Set(true); } else if (temp_uc \u003c= 20) { tec.Set(false); } std::this_thread::sleep_for(std::chrono::minutes(1)); } } int main() { control_tec(); } This implementation is functional, but fails to address important long-term considerations for production systems.\nWhat happens when the control law needs to change? What about when the GPIO is changed for a PWM output, or when the on-chip ADC is replaced with a more accurate off-chip device?\nHow do we make sure this code actually serves all our purposes? It doesn’t appear to handle errors. It doesn’t provide insight into the status of the controller. It doesn’t have any sense of configuration - the bounds are hard-coded. We have no facilities to log state, or understand if our feedback or actuation mechanisms have failed to accomplish their tasks.\nWhat about consistency across the codebase? If we are working in a system with lot of controllers - as many embedded systems and embedded software platforms must support - how do we make sure they’re all implemented in a consistent way? Consistency is critically important for maintaining developer velocity in complex code bases, and so it is a matter of utmost importance that we do not arbitrarily do the same thing in wildly different ways. As written a second control algorithm would violate the DRY principle - the knowledge of how control laws are structured should be centralized.\nAnd finally - what about testability? The folks who write these control laws are often not the embedded software teams. The control law is inextricably tied to the hardware used for gathering feedback and effecting output. Is the control team expected to maintain simulations for hardware in order to iterate on control laws? Are they bound in experimenting with new control algorithms by the existance of hardware drivers and hardware simulation infrastructure?\nThese problems can be addressed - and enforced across all controllers implemented in the codebase - by providing scaffolding for the domain of control law implementations.\nDefining a Framework for Closed-Loop Control Algorithms Requirements for the scaffolding can be derived from the above use cases:\nControl laws shall be independently testable from any specific hardware configuration. Controller feedback and actuation mechanisms shall explicitly handle all IO and configuration errors. Controllers shall emit representations of their current state suitable for logging. The data flow between the feedback, control law, and actuation mechanism shall be explicitly defined in order to enforce consistency. We also have these design goals:\nIt should be easy to write control laws that abide by the requirements. To the extent possible the constraints imposed by the requirements should be checked at compile-time. Components of a Controller The controller consists of three logically distinct components:\nA purely mathematical control law that receives inputs and computes outputs in order to achieve some goal. A feedback mechanism which interacts with some external interface to collect measurements. An output mechanism which effects the values commanded by the control law into the world. In a given step of the controller data flows first into the feedback component. Then, the data is converted to a format useable by the control law which uses the feedback to calculate the next output value. The output value from the controller is converted to the required data type to emit to a physical component.\nflowchart LR S[Feedback Sensor] FB[Feedback Componente.g., ADC] LAW[Control Lawe.g., Bang-Bang] ACT[Actuator Componente.g., GPIO] AHW[Actuator Hardware] S --\u003e|Raw measurement| FB FB --\u003e|Converted measurement| LAW LAW --\u003e|Command / control output| ACT ACT --\u003e|Actuation signal| AHW Let’s ground this in our TEC example. The ADC is the feedback. ADCs read a voltage. The control law for a TEC is going to deal with temperatures in degrees C, so the voltage must be converted to degrees. The control law emits a boolean - the TEC is on or off. For the bang-bang controller discussed earlier, the output GPIO uses the same data type as the controller output.\nThe data types for input and output from the control law constrain the feedback and actuator components. The control law cannot provide its own adapters without violating the independent testability requirement. Feedback and actuator interfaces must define those conversions themselves. Template concepts introduced in C++20 are naturally able to express the relationship between the interface data types.\nControlLaw Interface Let’s start out writing a concept for our most abstract component - the ControlLaw. The concept requires that each law defines its input and output types - Measurement and Command respectively. Laws must also define a State type.\nThere are two required APIs for a ControlLaw:\nInitialize configures the internal ControlLaw state. It must return the initialized State, or a string view in the case of an error. This is where the config for the law can be validated and return an error if necessary. Compute takes in a measurement, and returns a tuple of the next Command and its current State. These interfaces enforce two of our requirements - that the controller implements error handling, and that we have visibility into the current state of the controller.\ntemplate \u003ctypename C\u003e concept ControlLaw = requires(C law, const typename C::Measurement\u0026 m) { typename C::Measurement; typename C::Command; typename C::State; { law.Initialize() } -\u003e std::same_as\u003cstd::expected\u003ctypename C::State, std::string_view\u003e\u003e; { law.Compute(m) } -\u003e std::same_as\u003cstd::expected\u003cstd::pair\u003ctypename C::Command, typename C::State\u003e, std::string_view\u003e\u003e; }; Notice that the controller is completely independent of the actuator and feedback mechanisms. This decoupling enables our testability requirement - a class abiding by the ControlLaw concept can be instantiated independent of the larger controller infrastructure.\nExternal Interfaces Now let’s implement our Feedback and Actuator concepts. As discussed earlier, these interfaces are dependent on the ControlLaw’s defined data types. This is represented in our concepts as a template parameter for the ControlLaw, from which we extract the Measurement and Command data types:\ntemplate \u003ctypename FB, typename Law\u003e concept Feedback = ControlLaw\u003cLaw\u003e \u0026\u0026 requires(FB fb) { typename FB::State; { fb.Configure() } -\u003e std::same_as\u003cstd::expected\u003cvoid, std::string_view\u003e\u003e; { fb.Read() } -\u003e std::same_as\u003c std::expected\u003cstd::pair\u003ctypename Law::Measurement, typename FB::State\u003e, std::string_view\u003e\u003e; { fb.Convert(std::declval\u003ctypename FB::Raw\u003e()) } -\u003e std::same_as\u003ctypename Law::Measurement\u003e; }; template \u003ctypename AC, typename Law\u003e concept Actuator = ControlLaw\u003cLaw\u003e \u0026\u0026 requires(AC ac, const typename Law::Command\u0026 cmd) { typename AC::State; { ac.Configure() } -\u003e std::same_as\u003cstd::expected\u003cvoid, std::string_view\u003e\u003e; { ac.Write(cmd) } -\u003e std::same_as\u003cstd::expected\u003ctypename AC::State, std::string_view\u003e\u003e; { ac.Convert(std::declval\u003ctypename Law::Command\u003e()) } -\u003e std::same_as\u003ctypename AC::State\u003e; }; These concepts closely mirror each other. They are designed to encapsulate external-facing dependencies and abstract away conversion to the ControlLawtypes. The interface entails:\nA Configure function that ensures the output interfaces are ready for control and returns a string view on error. A function to interface with the external world - Read and Write for the Feedback and Actuator interfaces respectively. A Convert function that goes from the respective internal type to the data type expected by the template ControlLaw. Just as in the ControlLaw concept, std::expected is used to enforce error handling and state reporting.\nIntegrated Controller Finally, we implement an integrated Controller class. This class is templated on a specific set of Actuator, Feedback, and ControlLaw concept implementations. It orchestrates the dataflow between components and exposes the external interface to the represented controller.\ntemplate \u003cControlLaw Law, Feedback\u003cLaw\u003e FB, Actuator\u003cLaw\u003e ACT\u003e class Controller { public: using Measurement = typename Law::Measurement; using Command = typename Law::Command; Controller(FB\u0026 feedback, ACT\u0026 actuator, Law\u0026 law) : fb_(feedback), act_(actuator), law_(law) {} std::expected\u003ctypename Law::State, std::string_view\u003e Initialize() { auto err = fb_.Configure(); if (!err) { return std::unexpected(err.error()); } err = act_.Configure(); if (!err) { return std::unexpected(err.error()); } auto law_state = law_.Initialize(); if (!law_state) { return std::unexpected(law_state.error()); } return law_state.value(); } std::expected\u003cControllerState\u003cFB, Law, ACT\u003e, std::string_view\u003e Step() { auto fb_result = fb_.Read(); if (!fb_result) { return std::unexpected(fb_result.error()); } auto [measurement, fb_state] = *fb_result; auto law_result = law_.Compute(measurement); if (!law_result) { return std::unexpected(law_result.error()); } auto [command, law_state] = *law_result; auto act_result = act_.Write(command); if (!act_result) { return std::unexpected(act_result.error()); } auto act_state = *act_result; ControllerState\u003cFB, Law, ACT\u003e state{ .feedback_state = fb_state, .control_state = law_state, .actuator_state = act_state}; return state; } private: FB\u0026 fb_; ACT\u0026 act_; Law\u0026 law_; }; Revisiting the Bang-Bang Controller All the pieces are now in place to implement controllers using our generic template scaffolding. The following example implements the simple bang-bang controller for a TEC discussed earlier.\nFirst - we need to create concrete implementations of our ADC feedback, GPIO actuation, and bang-bang control law concepts. We use an auto template parameter for the conversion functions so that the entire set of functionality is determined at compile time. This approach is nice for embedded contexts where we really want to push as much work to compile-time as possible but does impose some limits on what your conversion function can do. If you need a capture in your conversion function for any reason, you could always pass the lambda into the constructor, or just hard-code it into your implementation if it won’t change.\nFile: example/components/feedback_controller/plugins/feedback/include/adc_feedback.hpp #pragma once #include \"adc_interface.hpp\" #include \"feedback_controller_interface.hpp\" template \u003cControlLaw LAW, auto Converter\u003e struct AdcFeedback { using Measurement = typename LAW::Measurement; using Raw = uint16_t; using State = std::pair\u003cMeasurement, Raw\u003e; AdcFeedback(Adc\u0026 adc) : adc_(adc) {} std::expected\u003cstd::pair\u003cMeasurement, State\u003e, std::string_view\u003e Read() { std::expected\u003cRaw, std::string_view\u003e maybe_raw = adc_.ReadRaw(); if (!maybe_raw.has_value()) { return std::unexpected(maybe_raw.error()); } const auto\u0026 raw = maybe_raw.value(); Measurement m = Convert(raw); return std::pair{m, std::pair{m, raw}}; } std::expected\u003cvoid, std::string_view\u003e Configure() { const auto configure_result = adc_.Configure(); if (!configure_result) { return std::unexpected(configure_result.error()); } return {}; } constexpr LAW::Measurement Convert(Raw raw) { return Converter(raw); }; private: Adc\u0026 adc_; };\nFile: example/components/feedback_controller/plugins/actuators/include/gpio_actuator.hpp #pragma once #include \"feedback_controller_interface.hpp\" #include \"gpio_interface.hpp\" template \u003cControlLaw LAW, auto Converter\u003e class GpioActuator { public: using Command = typename LAW::Command; using State = bool; GpioActuator(Gpio\u0026 gpio) : gpio_(gpio) {} std::expected\u003cState, std::string_view\u003e Write(const Command\u0026 cmd) { // A bit contrived for this example because the Command type // happens to be the same type for the GPIO interface. State gpio_state = Convert(cmd); const auto result = gpio_.Set(gpio_state); if (!result) { return std::unexpected(result.error()); } return gpio_state; } std::expected\u003cvoid, std::string_view\u003e Configure() { const auto configure_result = gpio_.Configure(Gpio::Output); if (!configure_result) { return std::unexpected(configure_result.error()); } return {}; } constexpr State Convert(LAW::Command command) { return Converter(command); }; private: Gpio\u0026 gpio_; };\nFile: example/components/feedback_controller/plugins/laws/include/bangbang_range.hpp #pragma once #include \"feedback_controller_interface.hpp\" struct BangBangRangeLaw { using Measurement = int32_t; using Command = bool; struct State { Command last_command{}; }; struct Config { Measurement min_threshold; Measurement max_threshold; }; BangBangRangeLaw(Measurement min_th, Measurement max_th) { config_.min_threshold = min_th; config_.max_threshold = max_th; } std::expected\u003cState, std::string_view\u003e Initialize() { State s{}; s.last_command = false; return s; } std::expected\u003cstd::pair\u003cCommand, State\u003e, std::string_view\u003e Compute(const Measurement\u0026 m) { if (m \u003e= config_.max_threshold) { state_.last_command = true; } else if (m \u003c= config_.min_threshold) { state_.last_command = false; } return std::make_pair(state_.last_command, state_); } State state_; Config config_; };\nIt is worth noting the framework is flexible for whatever configuration any given aspect of the controller requires. In this case, we provide min and max thresholds for the bang-bang controller. Let’s also create another version of our bangbang control law which controls to a specific setpoint instead of a range. We’ll use this later to demonstrate swapping parts of the controller.\nFile: example/components/feedback_controller/plugins/laws/include/bangbang_setpoint.hpp #pragma once #include \"feedback_controller_interface.hpp\" struct BangBangSetpointLaw { using Measurement = int32_t; using Command = bool; struct State { Command last_command{}; }; struct Config { Measurement setpoint; }; BangBangSetpointLaw(Measurement setpoint) { config_.setpoint = setpoint; } std::expected\u003cState, std::string_view\u003e Initialize() { State s{}; s.last_command = false; return s; } std::expected\u003cstd::pair\u003cCommand, State\u003e, std::string_view\u003e Compute(const Measurement\u0026 m) { if (m \u003e= config_.setpoint) { state_.last_command = true; } else { state_.last_command = false; } return std::make_pair(state_.last_command, state_); } State state_; Config config_; };\nWith these components - and the simulated ADC and GPIO interface implementations defined by the linked GitHub repo - we can actually instantiate and execute a controller. Instantiation is simple:\n// Simulated hardware SimulatedAdc adc; SimulatedGpio gpio; // Bang-bang control law BangBangRangeLaw law(20 /* min */, 80 /* max */); // ADC Feedback auto convert_adc = [](uint16_t raw) -\u003e BangBangLaw::Measurement { return static_cast\u003cBangBangRangeLaw::Measurement\u003e(raw) / 10; }; AdcFeedback\u003cBangBangRangeLaw, decltype(convert_adc)\u003e feedback(adc, convert_adc); // GPIO Actuator auto convert_gpio = [](bool cmd) -\u003e BangBangLaw::Command { return cmd; }; GpioActuator\u003cBangBangRangeLaw, decltype(convert_gpio)\u003e actuator(gpio, convert_gpio); // Integrated controller Controller\u003cBangBangRangeLaw, decltype(feedback), decltype(actuator)\u003e controller(feedback, actuator, law); We can now use the controller object to enact our control - first using the Initialize API to setup the hardware and control laws, and then the Step function to read inputs into and write outputs from the control law.\nCompile-Time Checks Let’s briefly explore what kinds of errors we get if we violate our concepts. One of the constraints is that our Configure functions handle errors by returning a std::expected. Let’s change our AdcFeedback Configure function such that it does not handle errors.\nvoid Configure() { adc_.Configure(); return; } Now if we try and build the sim:\n/Users/syellin/blog/examples/feedback-controller/example/bangbang_setpoint_sim/main.cpp:85:5: error: constraints not satisfied for class template 'Controller' [with Law = BangBangSetpointLaw, FB = AdcFeedback",
  "wordCount" : "3380",
  "inLanguage": "en",
  "datePublished": "2025-11-26T11:00:00-08:00",
  "dateModified": "2025-11-26T11:00:00-08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.volatileint.dev/posts/feedback-controller/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Volatile Int",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.volatileint.dev/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.volatileint.dev/" accesskey="h" title="Volatile Int (Alt + H)">Volatile Int</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.volatileint.dev/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://www.volatileint.dev/newsletter/" title="Newsletter">
                    <span>Newsletter</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43;
    </h1>
    <div class="post-meta"><span title='2025-11-26 11:00:00 -0800 PST'>November 26, 2025</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#a-simple-bang-bang-controller" aria-label="A Simple Bang-Bang Controller">A Simple Bang-Bang Controller</a></li>
                <li>
                    <a href="#defining-a-framework-for-closed-loop-control-algorithms" aria-label="Defining a Framework for Closed-Loop Control Algorithms">Defining a Framework for Closed-Loop Control Algorithms</a><ul>
                        
                <li>
                    <a href="#components-of-a-controller" aria-label="Components of a Controller">Components of a Controller</a><ul>
                        
                <li>
                    <a href="#controllaw-interface" aria-label="ControlLaw Interface">ControlLaw Interface</a></li>
                <li>
                    <a href="#external-interfaces" aria-label="External Interfaces">External Interfaces</a></li>
                <li>
                    <a href="#integrated-controller" aria-label="Integrated Controller">Integrated Controller</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#revisiting-the-bang-bang-controller" aria-label="Revisiting the Bang-Bang Controller">Revisiting the Bang-Bang Controller</a></li>
                <li>
                    <a href="#compile-time-checks" aria-label="Compile-Time Checks">Compile-Time Checks</a></li>
                <li>
                    <a href="#easily-swappable-components" aria-label="Easily Swappable Components">Easily Swappable Components</a></li>
                <li>
                    <a href="#exercises-for-the-reader" aria-label="Exercises for the Reader">Exercises for the Reader</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>In this post, we&rsquo;re going to implement a generic interface for creating a wide variety of closed-loop control systems. We&rsquo;ll end with a flexible template library capable of implementing whatever control algorithm you&rsquo;d want, enforced separation of concerns, flexible configuration, consistent error handling, and support for logging. We will use modern C++ infrastructure such as template <code>concept</code>s,  <code>std::expected</code>, and lambda functions.</p>
<p>Before we dive in, I want to acknowledge that the final code utilizes a good number of advanced C++ facilities for what may appear to be a relatively simple set of functionality. In the course of reading, you may balk at the complexity introduced for the sake of consistent abstraction. Hopefully the culmination of what we have built presented in the last section of the post sufficiently motivates the complexity tradeoff for projects with many controllers or which need to distribute the development responsibilities of the control laws and hardware interfaces across teams.</p>
<p>First, let&rsquo;s kick things off with a scenario.</p>
<h2 id="a-simple-bang-bang-controller">A Simple Bang-Bang Controller<a hidden class="anchor" aria-hidden="true" href="#a-simple-bang-bang-controller">#</a></h2>
<p>Picture yourself as an embedded software engineer working at a scrappy startup designing a revolutionary new technology with a healthy mix of hardware and software co-development. Your co-worker - a thermal engineer responsible for maintaining the health of a temperature-sensitive component of the system - approaches you, asking for software to regulate the temperature of their system:</p>
<ul>
<li>A thermoelectric cooler (henceforth referred to as a TEC) connected to the component that needs to be cooled. The engineer connected this to a simple switch which will apply either 0 or 100% power.</li>
<li>A thermocouple connected to the device being cooled to sense the temperature.</li>
<li>A microcontroller wired to control the TEC using the thermocouple as feedback.</li>
</ul>
<p>The system generates heat during operation, so the only active element necessary is a cooler. Analysis shows that component needs to be kept between 20 and 80 degrees Celsius. Every minute the temperature should be checked. If the reported temperature is 80 degrees of above then the TEC should be turned on until the temperature hits the lower bound of 20 degrees.</p>
<p>You write a very minimal program:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;chrono&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;gpio.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;adc.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">control_tec</span>() {
</span></span><span style="display:flex;"><span>    Gpio tec{ <span style="color:#ae81ff">1</span> }; <span style="color:#75715e">// TEC is on pin 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Adc thermocouple{ <span style="color:#ae81ff">2</span> }; <span style="color:#75715e">// thermocouple on pin 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    tec.Configure(Gpio<span style="color:#f92672">::</span>Output);
</span></span><span style="display:flex;"><span>    thermocouple.Configure();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> raw_temp_adc <span style="color:#f92672">=</span> thermocouple.read();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> temp_uc <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span>(raw) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (temp_uc <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">80</span>) {
</span></span><span style="display:flex;"><span>            tec.Set(true);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (temp_uc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">20</span>) {
</span></span><span style="display:flex;"><span>            tec.Set(false);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>sleep_for(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>minutes(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    control_tec();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This implementation is functional, but fails to address important long-term considerations for production systems.</p>
<p>What happens when the control law needs to change? What about when the GPIO is changed for a PWM output, or when the on-chip ADC is replaced with a more accurate off-chip device?</p>
<p>How do we make sure this code actually serves all our purposes? It doesn&rsquo;t appear to handle errors. It doesn&rsquo;t provide insight into the status of the controller. It doesn&rsquo;t have any sense of configuration - the bounds are hard-coded. We have no facilities to log state, or understand if our feedback or actuation mechanisms have failed to accomplish their tasks.</p>
<p>What about consistency across the codebase? If we are working in a system with lot of controllers - as many embedded systems and embedded software platforms must support - how do we make sure they&rsquo;re all implemented in a consistent way? Consistency is critically important for maintaining developer velocity in complex code bases, and so it is a matter of utmost importance that we do not arbitrarily do the same thing in wildly different ways. As written a second control algorithm would violate the DRY principle - the knowledge of <em>how control laws are structured</em> should be centralized.</p>
<p>And finally - what about testability? The folks who write these control laws are often not the embedded software teams. The control law is inextricably tied to the hardware used for gathering feedback and effecting output. Is the control team expected to maintain simulations for hardware in order to iterate on control laws? Are they bound in experimenting with new control algorithms by the existance of hardware drivers and hardware simulation infrastructure?</p>
<p>These problems can be addressed - and enforced across all controllers implemented in the codebase - by providing <em>scaffolding</em> for the domain of control law implementations.</p>
<h2 id="defining-a-framework-for-closed-loop-control-algorithms">Defining a Framework for Closed-Loop Control Algorithms<a hidden class="anchor" aria-hidden="true" href="#defining-a-framework-for-closed-loop-control-algorithms">#</a></h2>
<p>Requirements for the scaffolding can be derived from the above use cases:</p>
<ol>
<li>Control laws shall be independently testable from any specific hardware configuration.</li>
<li>Controller feedback and actuation mechanisms shall explicitly handle all IO and configuration errors.</li>
<li>Controllers shall emit representations of their current state suitable for logging.</li>
<li>The data flow between the feedback, control law, and actuation mechanism shall be explicitly defined in order to enforce consistency.</li>
</ol>
<p>We also have these design goals:</p>
<ol>
<li>It should be <em>easy</em> to write control laws that abide by the requirements.</li>
<li>To the extent possible the constraints imposed by the requirements should be checked at compile-time.</li>
</ol>
<h3 id="components-of-a-controller">Components of a Controller<a hidden class="anchor" aria-hidden="true" href="#components-of-a-controller">#</a></h3>
<p>The controller consists of three logically distinct components:</p>
<ol>
<li>A purely mathematical control law that receives inputs and computes outputs in order to achieve some goal.</li>
<li>A feedback mechanism which interacts with some external interface to collect measurements.</li>
<li>An output mechanism which effects the values commanded by the control law into the world.</li>
</ol>
<p>In a given step of the controller data flows first into the feedback component. Then, the data is converted to a format useable by the control law which uses the feedback to calculate the next output value. The output value from the controller is converted to the required data type to emit to a physical component.</p>
<div class="mermaid">
    
flowchart LR
  S[Feedback Sensor]
  FB[Feedback Component<br/>e.g., ADC]
  LAW[Control Law<br/>e.g., Bang-Bang]
  ACT[Actuator Component<br/>e.g., GPIO]
  AHW[Actuator Hardware]

  S -->|Raw measurement| FB
  FB -->|Converted measurement| LAW
  LAW -->|Command / control output| ACT
  ACT -->|Actuation signal| AHW

</div>
<p>Let&rsquo;s ground this in our TEC example. The ADC is the feedback. ADCs read a voltage. The control law for a TEC is going to deal with temperatures in degrees C, so the voltage must be converted to degrees. The control law emits a boolean - the TEC is on or off. For the bang-bang controller discussed earlier, the output GPIO uses the same data type as the controller output.</p>
<p>The data types for input and output from the control law <em>constrain</em> the feedback and actuator components. The control law cannot provide its own adapters without violating the independent testability requirement. Feedback and actuator interfaces must define those conversions themselves. Template <code>concept</code>s introduced in C++20 are naturally able to express the relationship between the interface data types.</p>
<h4 id="controllaw-interface">ControlLaw Interface<a hidden class="anchor" aria-hidden="true" href="#controllaw-interface">#</a></h4>
<p>Let&rsquo;s start out writing a concept for our most abstract component - the <code>ControlLaw</code>. The concept requires that each law defines its input and output types - <code>Measurement</code> and <code>Command</code> respectively. Laws must also define a <code>State</code> type.</p>
<p>There are two required APIs for a <code>ControlLaw</code>:</p>
<ol>
<li><code>Initialize</code> configures the internal <code>ControlLaw</code> state. It must return the initialized <code>State</code>, or a string view in the case of an error. This is where the config for the law can be validated and return an error if necessary.</li>
<li><code>Compute</code> takes in a measurement, and returns a tuple of the next <code>Command</code> and its current <code>State</code>.</li>
</ol>
<p>These interfaces enforce two of our requirements - that the controller implements error handling, and that we have visibility into the current state of the controller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> C<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">concept</span> ControlLaw <span style="color:#f92672">=</span> <span style="color:#66d9ef">requires</span>(C law, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>Measurement<span style="color:#f92672">&amp;</span> m) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>Measurement;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>Command;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>State;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { law.Initialize() } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        law.Compute(m)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>Command, <span style="color:#66d9ef">typename</span> C<span style="color:#f92672">::</span>State<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Notice that the controller is completely independent of the actuator and feedback mechanisms. This decoupling enables our testability requirement - a class abiding by the <code>ControlLaw</code> concept can be instantiated independent of the larger controller infrastructure.</p>
<h4 id="external-interfaces">External Interfaces<a hidden class="anchor" aria-hidden="true" href="#external-interfaces">#</a></h4>
<p>Now let&rsquo;s implement our Feedback and Actuator concepts. As discussed earlier, these interfaces are dependent on the <code>ControlLaw</code>&rsquo;s defined data types. This is represented in our concepts as a template parameter for the <code>ControlLaw</code>, from which we extract the <code>Measurement</code> and <code>Command</code> data types:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> FB, <span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">concept</span> Feedback <span style="color:#f92672">=</span> ControlLaw<span style="color:#f92672">&lt;</span>Law<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">requires</span>(FB fb) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typename</span> FB<span style="color:#f92672">::</span>State;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { fb.Configure() } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        fb.Read()
</span></span><span style="display:flex;"><span>    } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Measurement, <span style="color:#66d9ef">typename</span> FB<span style="color:#f92672">::</span>State<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { fb.Convert(std<span style="color:#f92672">::</span>declval<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> FB<span style="color:#f92672">::</span>Raw<span style="color:#f92672">&gt;</span>()) } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Measurement<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> AC, <span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">concept</span> Actuator <span style="color:#f92672">=</span> ControlLaw<span style="color:#f92672">&lt;</span>Law<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">requires</span>(AC ac, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Command<span style="color:#f92672">&amp;</span> cmd) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typename</span> AC<span style="color:#f92672">::</span>State;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { ac.Configure() } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { ac.Write(cmd) } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> AC<span style="color:#f92672">::</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    { ac.Convert(std<span style="color:#f92672">::</span>declval<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Command<span style="color:#f92672">&gt;</span>()) } <span style="color:#f92672">-&gt;</span> std<span style="color:#f92672">::</span>same_as<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> AC<span style="color:#f92672">::</span>State<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>These concepts closely mirror each other. They are designed to encapsulate external-facing dependencies and abstract away conversion to the <code>ControlLaw</code>types. The interface entails:</p>
<ol>
<li>A <code>Configure</code> function that ensures the output interfaces are ready for control and returns a string view on error.</li>
<li>A function to interface with the external world - <code>Read</code> and <code>Write</code> for the <code>Feedback</code> and <code>Actuator</code> interfaces respectively.</li>
<li>A <code>Convert</code> function that goes from the respective internal type to the data type expected by the template <code>ControlLaw</code>.</li>
</ol>
<p>Just as in the <code>ControlLaw</code> concept, <code>std::expected</code> is used to enforce error handling and state reporting.</p>
<h4 id="integrated-controller">Integrated Controller<a hidden class="anchor" aria-hidden="true" href="#integrated-controller">#</a></h4>
<p>Finally, we implement an integrated <code>Controller</code> class. This class is templated on a specific set of <code>Actuator</code>, <code>Feedback</code>, and <code>ControlLaw</code> concept implementations. It orchestrates the dataflow between components and exposes the external interface to the represented controller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span>ControlLaw Law, Feedback<span style="color:#f92672">&lt;</span>Law<span style="color:#f92672">&gt;</span> FB, Actuator<span style="color:#f92672">&lt;</span>Law<span style="color:#f92672">&gt;</span> ACT<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Controller</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> Measurement <span style="color:#f92672">=</span> <span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Measurement;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> Command <span style="color:#f92672">=</span> <span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>Command;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Controller(FB<span style="color:#f92672">&amp;</span> feedback, ACT<span style="color:#f92672">&amp;</span> actuator, Law<span style="color:#f92672">&amp;</span> law) <span style="color:#f92672">:</span> fb_(feedback), act_(actuator), law_(law) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Law<span style="color:#f92672">::</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> err <span style="color:#f92672">=</span> fb_.Configure();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>err) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(err.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        err <span style="color:#f92672">=</span> act_.Configure();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>err) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(err.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> law_state <span style="color:#f92672">=</span> law_.Initialize();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>law_state) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(law_state.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> law_state.value();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>ControllerState<span style="color:#f92672">&lt;</span>FB, Law, ACT<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> Step()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> fb_result <span style="color:#f92672">=</span> fb_.Read();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fb_result) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(fb_result.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> [measurement, fb_state] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>fb_result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> law_result <span style="color:#f92672">=</span> law_.Compute(measurement);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>law_result) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(law_result.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> [command, law_state] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>law_result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> act_result <span style="color:#f92672">=</span> act_.Write(command);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>act_result) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>unexpected(act_result.error());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> act_state <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>act_result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ControllerState<span style="color:#f92672">&lt;</span>FB, Law, ACT<span style="color:#f92672">&gt;</span> state{
</span></span><span style="display:flex;"><span>            .feedback_state <span style="color:#f92672">=</span> fb_state, .control_state <span style="color:#f92672">=</span> law_state, .actuator_state <span style="color:#f92672">=</span> act_state};
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    FB<span style="color:#f92672">&amp;</span> fb_;
</span></span><span style="display:flex;"><span>    ACT<span style="color:#f92672">&amp;</span> act_;
</span></span><span style="display:flex;"><span>    Law<span style="color:#f92672">&amp;</span> law_;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="revisiting-the-bang-bang-controller">Revisiting the Bang-Bang Controller<a hidden class="anchor" aria-hidden="true" href="#revisiting-the-bang-bang-controller">#</a></h2>
<p>All the pieces are now in place to implement controllers using our generic template scaffolding. The following example implements the simple bang-bang controller for a TEC discussed earlier.</p>
<p>First - we need to create concrete implementations of our ADC feedback, GPIO actuation, and bang-bang control law concepts. We use an <code>auto</code> template parameter for the conversion functions so that the entire set of functionality is determined at compile time. This approach is nice for embedded contexts where we really want to push as much work to compile-time as possible but does impose some limits on what your conversion function can do. If you need a capture in your conversion function for any reason, you could always pass the lambda into the constructor, or just hard-code it into your implementation if it won&rsquo;t change.</p>
<p><strong>File</strong>: <code>example/components/feedback_controller/plugins/feedback/include/adc_feedback.hpp</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;adc_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;feedback_controller_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>template <span style="color:#f92672">&lt;</span>ControlLaw LAW, <span style="color:#66d9ef">auto</span> Converter<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> AdcFeedback
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    using Measurement <span style="color:#f92672">=</span> <span style="color:#66d9ef">typename</span> LAW<span style="color:#f92672">::</span>Measurement;
</span></span><span style="display:flex;"><span>    using Raw <span style="color:#f92672">=</span> <span style="color:#66d9ef">uint16_t</span>;
</span></span><span style="display:flex;"><span>    using State <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>Measurement, Raw<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">AdcFeedback</span>(Adc<span style="color:#f92672">&amp;</span> adc) <span style="color:#f92672">:</span> <span style="color:#a6e22e">adc_</span>(adc) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>Measurement, State<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Read</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>Raw, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> maybe_raw <span style="color:#f92672">=</span> adc_.<span style="color:#a6e22e">ReadRaw</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>maybe_raw.<span style="color:#a6e22e">has_value</span>())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">unexpected</span>(maybe_raw.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> raw <span style="color:#f92672">=</span> maybe_raw.<span style="color:#a6e22e">value</span>();
</span></span><span style="display:flex;"><span>        Measurement m <span style="color:#f92672">=</span> <span style="color:#a6e22e">Convert</span>(raw);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span>pair{m, std<span style="color:#f92672">::</span>pair{m, raw}};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Configure</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> configure_result <span style="color:#f92672">=</span> adc_.<span style="color:#a6e22e">Configure</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>configure_result)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">unexpected</span>(configure_result.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    constexpr LAW<span style="color:#f92672">::</span>Measurement <span style="color:#a6e22e">Convert</span>(Raw raw)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Converter</span>(raw);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   private:
</span></span><span style="display:flex;"><span>    Adc<span style="color:#f92672">&amp;</span> adc_;
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div></p>
<p><strong>File</strong>: <code>example/components/feedback_controller/plugins/actuators/include/gpio_actuator.hpp</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;feedback_controller_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;gpio_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>template <span style="color:#f92672">&lt;</span>ControlLaw LAW, <span style="color:#66d9ef">auto</span> Converter<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>class GpioActuator
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   public:
</span></span><span style="display:flex;"><span>    using Command <span style="color:#f92672">=</span> <span style="color:#66d9ef">typename</span> LAW<span style="color:#f92672">::</span>Command;
</span></span><span style="display:flex;"><span>    using State <span style="color:#f92672">=</span> <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GpioActuator</span>(Gpio<span style="color:#f92672">&amp;</span> gpio) <span style="color:#f92672">:</span> <span style="color:#a6e22e">gpio_</span>(gpio) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Write</span>(<span style="color:#66d9ef">const</span> Command<span style="color:#f92672">&amp;</span> cmd)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// A bit contrived for this example because the Command type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// happens to be the same type for the GPIO interface.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        State gpio_state <span style="color:#f92672">=</span> <span style="color:#a6e22e">Convert</span>(cmd);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> result <span style="color:#f92672">=</span> gpio_.<span style="color:#a6e22e">Set</span>(gpio_state);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>result)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">unexpected</span>(result.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gpio_state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Configure</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span> configure_result <span style="color:#f92672">=</span> gpio_.<span style="color:#a6e22e">Configure</span>(Gpio<span style="color:#f92672">::</span>Output);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>configure_result)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">unexpected</span>(configure_result.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    constexpr State <span style="color:#a6e22e">Convert</span>(LAW<span style="color:#f92672">::</span>Command command)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Converter</span>(command);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   private:
</span></span><span style="display:flex;"><span>    Gpio<span style="color:#f92672">&amp;</span> gpio_;
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div></p>
<p><strong>File</strong>: <code>example/components/feedback_controller/plugins/laws/include/bangbang_range.hpp</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;feedback_controller_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> BangBangRangeLaw
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    using Measurement <span style="color:#f92672">=</span> <span style="color:#66d9ef">int32_t</span>;
</span></span><span style="display:flex;"><span>    using Command <span style="color:#f92672">=</span> <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> State
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Command last_command{};
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> Config
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Measurement min_threshold;
</span></span><span style="display:flex;"><span>        Measurement max_threshold;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">BangBangRangeLaw</span>(Measurement min_th, Measurement max_th)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        config_.min_threshold <span style="color:#f92672">=</span> min_th;
</span></span><span style="display:flex;"><span>        config_.max_threshold <span style="color:#f92672">=</span> max_th;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Initialize</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        State s{};
</span></span><span style="display:flex;"><span>        s.last_command <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> s;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>Command, State<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Compute</span>(<span style="color:#66d9ef">const</span> Measurement<span style="color:#f92672">&amp;</span> m)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (m <span style="color:#f92672">&gt;=</span> config_.max_threshold)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            state_.last_command <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (m <span style="color:#f92672">&lt;=</span> config_.min_threshold)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            state_.last_command <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">make_pair</span>(state_.last_command, state_);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    State state_;
</span></span><span style="display:flex;"><span>    Config config_;
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div></p>
<p>It is worth noting the framework is flexible for whatever configuration any given aspect of the controller requires. In this case, we provide min and max thresholds for the bang-bang controller. Let&rsquo;s also create another version of our bangbang control law which controls to a specific setpoint instead of a range. We&rsquo;ll use this later to demonstrate swapping parts of the controller.</p>
<p><strong>File</strong>: <code>example/components/feedback_controller/plugins/laws/include/bangbang_setpoint.hpp</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;feedback_controller_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> BangBangSetpointLaw
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    using Measurement <span style="color:#f92672">=</span> <span style="color:#66d9ef">int32_t</span>;
</span></span><span style="display:flex;"><span>    using Command <span style="color:#f92672">=</span> <span style="color:#66d9ef">bool</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> State
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Command last_command{};
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> Config
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Measurement setpoint;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">BangBangSetpointLaw</span>(Measurement setpoint)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        config_.setpoint <span style="color:#f92672">=</span> setpoint;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>State, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Initialize</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        State s{};
</span></span><span style="display:flex;"><span>        s.last_command <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> s;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>expected<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>Command, State<span style="color:#f92672">&gt;</span>, std<span style="color:#f92672">::</span>string_view<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">Compute</span>(<span style="color:#66d9ef">const</span> Measurement<span style="color:#f92672">&amp;</span> m)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (m <span style="color:#f92672">&gt;=</span> config_.setpoint)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            state_.last_command <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            state_.last_command <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">make_pair</span>(state_.last_command, state_);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    State state_;
</span></span><span style="display:flex;"><span>    Config config_;
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div></p>
<p>With these components - and the simulated ADC and GPIO interface implementations defined by the <a href="https://github.com/sam-w-yellin/feedback-controller">linked GitHub repo</a>  - we can actually instantiate and execute a controller. Instantiation is simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// Simulated hardware
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SimulatedAdc adc;
</span></span><span style="display:flex;"><span>SimulatedGpio gpio;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Bang-bang control law
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BangBangRangeLaw <span style="color:#a6e22e">law</span>(<span style="color:#ae81ff">20</span> <span style="color:#75715e">/* min */</span>, <span style="color:#ae81ff">80</span> <span style="color:#75715e">/* max */</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ADC Feedback
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">auto</span> convert_adc <span style="color:#f92672">=</span> [](<span style="color:#66d9ef">uint16_t</span> raw) <span style="color:#f92672">-&gt;</span> BangBangLaw<span style="color:#f92672">::</span>Measurement
</span></span><span style="display:flex;"><span>{ <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>BangBangRangeLaw<span style="color:#f92672">::</span>Measurement<span style="color:#f92672">&gt;</span>(raw) <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>; };
</span></span><span style="display:flex;"><span>AdcFeedback<span style="color:#f92672">&lt;</span>BangBangRangeLaw, <span style="color:#66d9ef">decltype</span>(convert_adc)<span style="color:#f92672">&gt;</span> feedback(adc, convert_adc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GPIO Actuator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">auto</span> convert_gpio <span style="color:#f92672">=</span> [](<span style="color:#66d9ef">bool</span> cmd) <span style="color:#f92672">-&gt;</span> BangBangLaw<span style="color:#f92672">::</span>Command { <span style="color:#66d9ef">return</span> cmd; };
</span></span><span style="display:flex;"><span>GpioActuator<span style="color:#f92672">&lt;</span>BangBangRangeLaw, <span style="color:#66d9ef">decltype</span>(convert_gpio)<span style="color:#f92672">&gt;</span> actuator(gpio, convert_gpio);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Integrated controller
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Controller<span style="color:#f92672">&lt;</span>BangBangRangeLaw, <span style="color:#66d9ef">decltype</span>(feedback), <span style="color:#66d9ef">decltype</span>(actuator)<span style="color:#f92672">&gt;</span> controller(feedback, actuator,
</span></span><span style="display:flex;"><span>                                                                            law);
</span></span></code></pre></div><p>We can now use the <code>controller</code> object to enact our control - first using the <code>Initialize</code> API to setup the hardware and control laws, and then the <code>Step</code> function to read inputs into and write outputs from the control law.</p>
<h2 id="compile-time-checks">Compile-Time Checks<a hidden class="anchor" aria-hidden="true" href="#compile-time-checks">#</a></h2>
<p>Let&rsquo;s briefly explore what kinds of errors we get if we violate our concepts. One of the constraints is that our <code>Configure</code> functions handle errors by returning a <code>std::expected</code>. Let&rsquo;s change our AdcFeedback <code>Configure</code> function such that it does not handle errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Configure</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    adc_.Configure();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now if we try and build the sim:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/Users/syellin/blog/examples/feedback-controller/example/bangbang_setpoint_sim/main.cpp:85:5: error: constraints not satisfied <span style="color:#66d9ef">for</span> class template <span style="color:#e6db74">&#39;Controller&#39;</span> <span style="color:#f92672">[</span>with Law <span style="color:#f92672">=</span> BangBangSetpointLaw, FB <span style="color:#f92672">=</span> AdcFeedback&lt;BangBangSetpointLaw, <span style="color:#f92672">(</span>lambda at /Users/syellin/blog/examples/feedback-controller/example/bangbang_setpoint_sim/main.cpp:76:38<span style="color:#f92672">){}</span>&gt;, ACT <span style="color:#f92672">=</span> GpioActuator&lt;BangBangSetpointLaw, <span style="color:#f92672">(</span>lambda at /Users/syellin/blog/examples/feedback-controller/example/bangbang_setpoint_sim/main.cpp:81:39<span style="color:#f92672">){}</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">85</span> |     Controller&lt;BangBangSetpointLaw, decltype<span style="color:#f92672">(</span>feedback<span style="color:#f92672">)</span>, decltype<span style="color:#f92672">(</span>actuator<span style="color:#f92672">)</span>&gt; controller<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      |     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span style="display:flex;"><span>/Users/syellin/blog/examples/feedback-controller/include/feedback_controller_interface.hpp:55:27: note: because <span style="color:#e6db74">&#39;Feedback&lt;AdcFeedback&lt;BangBangSetpointLaw, (lambda at /Users/syellin/blog/examples/feedback-controller/example/bangbang_setpoint_sim/main.cpp:76:38){}&gt;, BangBangSetpointLaw&gt;&#39;</span> evaluated to false
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">55</span> | template &lt;ControlLaw Law, Feedback&lt;Law&gt; FB, Actuator&lt;Law&gt; ACT&gt;
</span></span><span style="display:flex;"><span>      |                           ^
</span></span><span style="display:flex;"><span>/Users/syellin/blog/examples/feedback-controller/include/feedback_controller_interface.hpp:34:27: note: because type constraint <span style="color:#e6db74">&#39;std::same_as&lt;void, std::expected&lt;void, std::string_view&gt; &gt;&#39;</span> was not satisfied:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">34</span> |     <span style="color:#f92672">{</span> fb.Configure<span style="color:#f92672">()</span> <span style="color:#f92672">}</span> -&gt; std::same_as&lt;std::expected&lt;void, std::string_view&gt;&gt;;
</span></span></code></pre></div><p>We are told <em>exactly</em> what is wrong - our <code>Configure</code> function has the wrong return type. Similar errors will occur if any other aspect of the contract is violated.</p>
<p>Its also worth taking a look at the lambda functions performing conversions. This is dependent on your particlar <code>Feedback</code> and <code>Actuator</code> interface implementations, but in our case a mismatch between the lambda return type and the <code>concept</code> dictated value will be caught at compile time <em>as long as you compile with <code>-WConversion</code></em>. Of course, you <strong>are</strong> compiling with <code>-Wconversion</code>, right?</p>
<p>So, we have achieved the design goals: We both have compile-time checks that our interfaces are well formed, and the code is easy to debug when they are not.</p>
<h2 id="easily-swappable-components">Easily Swappable Components<a hidden class="anchor" aria-hidden="true" href="#easily-swappable-components">#</a></h2>
<p>The following code utilizes the bang-bang controller - instantiated through our scaffolding - to run 1000 steps of the control simulation. This example demonstrates all our requirements - error handling, loggability, strict enforcement at compile-time.</p>
<p><strong>File</strong>: <code>example/feedback-controller/example/bangbang_range_sim/main.cpp</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fstream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;print&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;adc.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;adc_feedback.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;bangbang_range.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;feedback_controller_interface.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;gpio.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;gpio_actuator.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> SimplePlant
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> temperature_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">step</span>(<span style="color:#66d9ef">bool</span> cooling_on)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cooling_on)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            temperature_c <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            temperature_c <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// convert °C → ADC raw units (0–65535)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// assume 0.1 deg c per raw tick
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint16_t</span> <span style="color:#a6e22e">adc_reading</span>() <span style="color:#66d9ef">const</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> static_cast<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">&gt;</span>(temperature_c <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string <span style="color:#a6e22e">FormatState</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> state)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> std<span style="color:#f92672">::</span><span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;TEMP_C: {}, GPIO: {}, CMD: {}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, state.feedback_state.first,
</span></span><span style="display:flex;"><span>                       state.actuator_state, state.control_state.last_command);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunTecSim</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> controller, <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> sim_adc, <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> sim_gpio)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>ofstream <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;sim.log&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>log)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span><span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Failed to open sim.log.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SimplePlant plant;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        sim_adc.<span style="color:#a6e22e">SetRawValue</span>(plant.<span style="color:#a6e22e">adc_reading</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> maybe_state <span style="color:#f92672">=</span> controller.<span style="color:#a6e22e">Step</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>maybe_state.<span style="color:#a6e22e">has_value</span>())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span><span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Error: {}&#34;</span>, maybe_state.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> cooling_on <span style="color:#f92672">=</span> sim_gpio.<span style="color:#a6e22e">Read</span>().<span style="color:#a6e22e">value</span>();
</span></span><span style="display:flex;"><span>        plant.<span style="color:#a6e22e">step</span>(cooling_on);
</span></span><span style="display:flex;"><span>        log <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">FormatState</span>(maybe_state.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Simulated hardware
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SimulatedAdc adc;
</span></span><span style="display:flex;"><span>    SimulatedGpio gpio;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Bang-bang control law
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    BangBangRangeLaw <span style="color:#a6e22e">law</span>(<span style="color:#ae81ff">20</span> <span style="color:#75715e">/* min */</span>, <span style="color:#ae81ff">80</span> <span style="color:#75715e">/* max */</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ADC Feedback
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    AdcFeedback<span style="color:#f92672">&lt;</span>BangBangRangeLaw, [](<span style="color:#66d9ef">uint16_t</span> raw) <span style="color:#f92672">-&gt;</span> BangBangRangeLaw<span style="color:#f92672">::</span>Measurement
</span></span><span style="display:flex;"><span>                { <span style="color:#66d9ef">return</span> static_cast<span style="color:#f92672">&lt;</span>BangBangRangeLaw<span style="color:#f92672">::</span>Measurement<span style="color:#f92672">&gt;</span>(raw) <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>; }<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">feedback</span>(adc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// GPIO Actuator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    GpioActuator<span style="color:#f92672">&lt;</span>BangBangRangeLaw, [](<span style="color:#66d9ef">bool</span> cmd) <span style="color:#f92672">-&gt;</span> BangBangRangeLaw<span style="color:#f92672">::</span>Command { <span style="color:#66d9ef">return</span> cmd; }<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">actuator</span>(gpio);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Integrated controller
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Controller<span style="color:#f92672">&lt;</span>BangBangRangeLaw, <span style="color:#a6e22e">decltype</span>(feedback), <span style="color:#a6e22e">decltype</span>(actuator)<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">controller</span>(feedback,
</span></span><span style="display:flex;"><span>                                                                                    actuator, law);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> init <span style="color:#f92672">=</span> controller.<span style="color:#a6e22e">Initialize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>init.<span style="color:#a6e22e">has_value</span>())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span><span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Controller init error: {}&#34;</span>, init.<span style="color:#a6e22e">error</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RunTecSim</span>(controller, adc, gpio);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></p>
<p>After building and executing this simulation, and running the included <code>graph_log.py</code> script - you&rsquo;ll see an output like this:</p>
<p><img alt="bang-bang range-based controller output" loading="lazy" src="https://www.volatileint.dev/posts/feedback-controller/bangbang-range.png"></p>
<p>Let&rsquo;s demonstrate our ability to change controller components independently. If we swap the control law implementations we can create different control behavior without ever touching code related to actuation or feedback. When we run the sim using the setpoint control law, we get the following output:</p>
<p><img alt="bang-bang setpoint-based controller output" loading="lazy" src="https://www.volatileint.dev/posts/feedback-controller/bangbang-setpoint.png"></p>
<p>The entire difference between these two simulations is constrained to details of the control law. This is the only functional difference:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>73c73
</span></span><span style="display:flex;"><span>&lt;     BangBangRangeLaw law<span style="color:#f92672">(</span><span style="color:#ae81ff">20</span> /* min */, <span style="color:#ae81ff">80</span> /* max */<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>&gt;     BangBangSetpointLaw law<span style="color:#f92672">(</span><span style="color:#ae81ff">60</span> /* setpoint deg c */<span style="color:#f92672">)</span>;
</span></span></code></pre></div><h2 id="exercises-for-the-reader">Exercises for the Reader<a hidden class="anchor" aria-hidden="true" href="#exercises-for-the-reader">#</a></h2>
<p>I encourage you to try extending this functionality yourself! Consider these challenges:</p>
<ol>
<li>Enable runtime configuration of the controller via dependency inversion by creating a base class for each of the concepts.</li>
<li>Currently, the <code>State</code> objects must be move/copy constructable. Explain why that is the case, and modify the code to permit returning non-copy-able and non-move-able <code>State</code> objects</li>
<li>Use of <code>std::string_view</code> as an error type is fine in most contexts. It avoids any dynamic memory allocation given by <code>std::string</code>. Even still, highly resource constrained systems may benefit from their own error types with smaller footprints - such as an enumeration. Change the implementation to require a templatized error type. Hint: you may need to look at something like <code>std::variant</code> to bubble up the final returned error from the <code>Controller</code> class.</li>
</ol>
<p>These exercises both may be very useful to some applications, and are great ways to apply the patterns learned in this post.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>The design we&rsquo;ve implemented demonstrates all the requirements and design goals we set out to achieve. If you are operating in an ecosystem of control laws, this pattern is almost certainly useful. I have implemented similar patterns at multiple organizations and reaped the benefits of consistent control interfaces and implementations at scale. The benefits of cleanly defined component boundaries and separate responsibilities, enforced error checking and state exposure, and swappable feedback/actuator/law implementations come at the cost of complexity. Not only is this implementation more verbose than the simple controller we saw at the beginning - it is undoubtedly more complex. Understanding this implementation fully demands quite a lot from the code maintainers. To reaffirm - this solution makes sense in an <em>ecosystem</em> of controllers.</p>
<p>The feedback controller interface is available on <a href="https://github.com/sam-w-yellin/feedback-controller">GitHub</a> as a single-header to anyone who wants to use it or try out the exercises outlined above. The simulation framework included in the repo also could prove useful to anyone iterating on controllers.</p>
<p>If you found this article valuable, consider subscribing to the <a href="https://volatileint.dev/newsletter">newsletter</a> to hear about new posts! If you have any feedback or questions, reach out to me at <a href="mailto:sam@volatileint.dev">sam@volatileint.dev</a>!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.volatileint.dev/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
      <li><a href="https://www.volatileint.dev/tags/feedback/">Feedback</a></li>
      <li><a href="https://www.volatileint.dev/tags/control/">Control</a></li>
      <li><a href="https://www.volatileint.dev/tags/law/">Law</a></li>
      <li><a href="https://www.volatileint.dev/tags/actuator/">Actuator</a></li>
      <li><a href="https://www.volatileint.dev/tags/concept/">Concept</a></li>
      <li><a href="https://www.volatileint.dev/tags/embedded/">Embedded</a></li>
      <li><a href="https://www.volatileint.dev/tags/template/">Template</a></li>
      <li><a href="https://www.volatileint.dev/tags/lambda/">Lambda</a></li>
      <li><a href="https://www.volatileint.dev/tags/logging/">Logging</a></li>
    </ul>

<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on x"
            href="https://x.com/intent/tweet/?text=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b&amp;url=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f&amp;hashtags=C%2b%2b%2cfeedback%2ccontrol%2claw%2cactuator%2cconcept%2cembedded%2ctemplate%2clambda%2clogging">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f&amp;title=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b&amp;summary=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b&amp;source=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f&title=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on whatsapp"
            href="https://api.whatsapp.com/send?text=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b%20-%20https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on telegram"
            href="https://telegram.me/share/url?text=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b&amp;url=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Implementing a Framework For Closed-Loop Controllers in Modern C&#43;&#43; on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Implementing%20a%20Framework%20For%20Closed-Loop%20Controllers%20in%20Modern%20C%2b%2b&u=https%3a%2f%2fwww.volatileint.dev%2fposts%2ffeedback-controller%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://www.volatileint.dev/">Volatile Int</a></span> · 
    <span>
        <a href="https://www.volatileint.dev/index.xml">Subscribe via RSS</a>
    </span> · 
    <span>
        <a href="https://buttondown.com/volatileint">Subscribe via Newsletter</a>
    </span> · 
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({ startOnLoad: true });
</script>
</body>
</html>
